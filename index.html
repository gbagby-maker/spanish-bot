<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profe Bot Ultra</title>
    <style>
        :root {
            --accent: #e74c3c;
            --bot-bubble: #f1f0f0;
            --user-bubble: #e74c3c;
            --bg: #ffffff;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f7f9; margin: 0; display: flex; justify-content: center; height: 100vh; }
        #app-container { width: 100%; max-width: 500px; background: var(--bg); display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        #header { background: var(--accent); color: white; padding: 20px; text-align: center; border-bottom: 2px solid rgba(0,0,0,0.1); }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .msg { padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; max-width: 80%; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .bot { background: var(--bot-bubble); color: #2c3e50; align-self: flex-start; border-bottom-left-radius: 4px; }
        .user { background: var(--user-bubble); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        #controls { padding: 25px; border-top: 1px solid #eee; background: #fafafa; display: flex; flex-direction: column; align-items: center; }
        #micBtn { width: 80px; height: 80px; border-radius: 50%; border: none; background: var(--accent); color: white; font-size: 24px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4); margin-bottom: 10px; }
        #micBtn.listening { background: #2ecc71; transform: scale(1.1); box-shadow: 0 0 20px rgba(46, 204, 113, 0.6); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(46, 204, 113, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }
        #status { font-size: 12px; font-weight: bold; color: #95a5a6; text-transform: uppercase; letter-spacing: 1px; }
        .voice-info { font-size: 10px; color: #bdc3c7; margin-top: 5px; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="header">
        <strong>Profe de EspaÃ±ol</strong><br>
        <span style="font-size: 12px; opacity: 0.9;">Escuchar y Hablar</span>
    </div>
    <div id="chat-box" id="chatBox">
        <div class="msg bot">Â¡Hola! I am your new Spanish tutor. <br><br>1. Ask me "How do you say [word]?"<br>2. Say "Hola" to start a chat!</div>
    </div>
    <div id="controls">
        <button id="micBtn">ðŸŽ¤</button>
        <div id="status">Ready</div>
        <div class="voice-info" id="voiceName">Loading voices...</div>
    </div>
</div>

<script>
    const micBtn = document.getElementById('micBtn');
    const status = document.getElementById('status');
    const chatBox = document.getElementById('chat-box');
    const voiceDisplay = document.getElementById('voiceName');

    const synth = window.speechSynthesis;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();

    // TUNING THE LISTENER
    recognition.lang = 'es-MX'; // Set to Mexican Spanish for US students
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    let bestVoice = null;

    // FIND THE BEST VOICE (Neural/Premium voices)
    function loadVoices() {
        const voices = synth.getVoices();
        // Priority list: Google Neural voices > Microsoft Natural > Standard Spanish
        bestVoice = voices.find(v => v.name.includes('Neural') && v.lang.includes('es')) ||
                    voices.find(v => v.name.includes('Google') && v.lang.includes('es')) ||
                    voices.find(v => v.lang.includes('es'));
        
        if (bestVoice) {
            voiceDisplay.innerText = "Voice Active: " + bestVoice.name;
        }
    }

    // Chrome/Edge load voices asynchronously
    if (synth.onvoiceschanged !== undefined) {
        synth.onvoiceschanged = loadVoices;
    }

    function speak(text) {
        synth.cancel(); // Stop talking if already talking
        const utter = new SpeechSynthesisUtterance(text);
        utter.voice = bestVoice;
        utter.rate = 0.85; // Natural, slightly slower speed
        utter.pitch = 1.0;
        synth.speak(utter);
    }

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `msg ${sender}`;
        div.innerHTML = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function getResponse(input) {
        const text = input.toLowerCase();
        
        if (text.includes("how do you say") || text.includes("how do i say")) {
            const query = text.replace("how do you say", "").replace("how do i say", "").trim();
            return `The word for "${query}" is usually translated as <strong>'Traducir'</strong>. Try saying it back to me!`;
        } 
        
        if (text.includes("hola") || text.includes("buenos dÃ­as")) {
            return "Â¡Hola estudiante! Â¿CÃ³mo estÃ¡s el dÃ­a de hoy?";
        }

        if (text.includes("bien") || text.includes("excelente")) {
            return "Â¡QuÃ© bueno! Me da mucho gusto. Â¿Quieres practicar vocabulario de la comida o de la escuela?";
        }

        return "Â¡Te escucho muy bien! Tu pronunciaciÃ³n es excelente. Â¿Tienes otra pregunta?";
    }

    micBtn.onclick = () => {
        try {
            recognition.start();
            status.innerText = "Listening...";
            micBtn.classList.add('listening');
        } catch (e) {
            console.log("Recognition already started");
        }
    };

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        addMessage(transcript, 'user');
        
        setTimeout(() => {
            const reply = getResponse(transcript);
            addMessage(reply, 'bot');
            speak(reply.replace(/<[^>]*>?/gm, '')); // Strip HTML tags before speaking
        }, 600);
    };

    recognition.onend = () => {
        status.innerText = "Ready";
        micBtn.classList.remove('listening');
    };

    recognition.onerror = (e) => {
        status.innerText = "Error: " + e.error;
        micBtn.classList.remove('listening');
    };
</script>

</body>
</html>
